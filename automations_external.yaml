# trigger automtic backup.
- id: AutoBackup
  alias: Automatic Daily Snapshot
  description: Run snapshot daily and retain for 14 days
  trigger:
    - platform: time
      at: 02:00:05
  action:
    - service: auto_backup.snapshot_full
      data:
        name: "DailyBackup: {{ now().strftime('%A, %B %-d, %Y') }}"
        keep_days: 14

# automations to adjust Guest device tracker, used by Guest person
# when binary sensor is changed.
- id: "1616560803743"
  alias: Guest_DT_Home
  description: Switch Guest Device Tracker to home when guests are on Wifi
  trigger:
    - platform: state
      entity_id: binary_sensor.wifi_guests
      to: "on"
      from: "off"
  condition: []
  action:
    - service: device_tracker.see
      data:
        dev_id: guest
        location_name: home
  mode: single
- id: "1616560899377"
  alias: Guest_DT_Not_Home
  description: Set Guest device tracker to Not Home when Guest not detected on Wifi
  trigger:
    - platform: state
      entity_id: binary_sensor.wifi_guests
      from: "on"
      for: 00:05:00
      to: "off"
  condition: []
  action:
    - service: device_tracker.see
      data:
        dev_id: guest
        location_name: not_home
  mode: single

# adjust presence indicator based upon status of Person entities.
- id: PresenceChanging
  alias: Presence_Changing
  description: Trigger when presence is changing
  trigger:
    - platform: state
      entity_id:
        - person.guest
        - person.axel_larsson
      to:
        - home
        - not_home
  condition:
    - condition: state
      entity_id: input_boolean.hold_presence
      state: "off"
  action:
    - choose:
        - alias: If nobody is home, set to Away
          conditions:
            - condition: state
              entity_id:
                - person.guest
                - person.axel_larsson
              state: not_home
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.presence
                option: Away
        - alias: If Guest is home, set to With Guests
          conditions:
            - condition: state
              entity_id: person.guest
              state: home
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.presence
                option: With Guests
        - alias: If Axel is home set to Home
          conditions:
            - condition: state
              entity_id: person.axel_larsson
              state: home
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.presence
                option: Home

# turn off TVs and lights when leaving.
- id: TurnOffWhenLeaving
  alias: Turn_Off_When_Leaving
  description: Turn devices off when leaving
  trigger:
    - platform: state
      entity_id: input_select.presence
      to: Away
      for: 00:00:45
  action:
    - service: light.turn_off
      entity_id: 
        - light.den_lights
        - light.vestibule_switch
        - light.bedroom_lamp
        - light.under_stooop_lights
        - light.living_room
        - light.laundry_room
        - light.office
        - light.guest_room
        - light.master_bedroom
        - light.kitchen
    - service: remote.turn_off
      entity_id: remote.living_room_2
    - service: remote.turn_off
      entity_id: remote.den

# turn lights on when arriving, if its after sunset.
- id: TurnLight123
  alias: Turn_Light_On_Arriving
  description: Turn lights on in the evening
  trigger:
    - platform: state
      entity_id: input_select.presence
      from: Away
      to:
        - Home
        - With Guests
  condition:
    - condition: state
      entity_id: sun.sun
      state: below_horizon
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.common_area_normal_lighting

# TV watching motion sensor control
- id: "1617150949677"
  alias: Living Room TV motion sensor off
  description: Turn off living room motion sensor when watching TV
  trigger:
    - platform: state
      entity_id: remote.living_room_2
      from: "off"
      to: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.living_room_motion_sensor
  mode: single

- id: "1617150949699"
  alias: Living Room TV motion sensor on
  description: Turn on living room motion sensor when finished watching TV
  trigger:
    - platform: state
      entity_id: remote.living_room_2
      from: "on"
      to: "off"
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.living_room_motion_sensor
  mode: single

# TV watching motion sensor control
- id: "1617150949677a"
  alias: Den TV motion sensor off
  description: Turn off living room motion sensor when watching TV
  trigger:
    - platform: state
      entity_id: remote.den
      from: "off"
      to: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.den_motion_sensor
  mode: single

- id: "1617150949699b"
  alias: Den TV motion sensor on
  description: Turn on living room motion sensor when finished watching TV
  trigger:
    - platform: state
      entity_id: remote.den
      from: "on"
      to: "off"
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.den_motion_sensor
  mode: single

# smart wake up trigers.
# master bedroom Alexa alarm trigger.
- id: SmartWakeUpMasterBedroom
  alias: Smart Wake Up Master Bedroom
  trigger:
    - minutes: /5
      platform: time_pattern
  condition:
    - condition: time
      after: 02:00:00
      before: 09:00:00
    - condition: template
      value_template: "{{ state_attr('automation.smart_wake_up_master_bedroom', 'last_triggered').day != utcnow().day }}"
    - condition: template
      value_template: "{{ states('sensor.bedroom_next_alarm') != 'unavailable' and as_timestamp(states('sensor.bedroom_next_alarm')) - as_timestamp(now()) <= 3600 }}"
  action:
    - service: script.wake_up
      data:
        warmer: master_bath_towel_warmer

# master bedroom fallback
- id: SmartWakeUpMasterBedroomFallback
  alias: Fallback time for Master Bedroom Wake-up sequence
  trigger:
    - at: 09:00:00
      platform: time
  condition:
    - condition: state
      entity_id: input_select.presence
      state:
        - Home
        - With Guests
    - condition: template
      value_template: "{{ state_attr('automation.smart_wake_up_master_bedroom', 'last_triggered').day != utcnow().day }}"
  action:
    - service: script.wake_up
      data:
        warmer: master_bath_towel_warmer

# guest room alexa alarm trigger
- id: SmartWakeUpGuestRoom
  alias: Smart Wake Up Guest Room
  trigger:
    - minutes: /5
      platform: time_pattern
  condition:
    - condition: time
      after: 02:00:00
      before: 09:00:00
    - condition: template
      value_template: "{{ state_attr('automation.smart_wake_up_guest_room','last_triggered').day != utcnow().day }}"
    - condition: template
      value_template: "{{ states('sensor.guest_room_next_alarm') != 'unavailable' and as_timestamp(states('sensor.guest_room_next_alarm')) - as_timestamp(now()) <= 3600 }}"
  action:
    - service: script.wake_up
      data:
        warmer: guest_bath_towel_warmer

# guest room fallback
- id: SmartWakeUpGuestRoomFallback
  alias: Fallback time for Guest Room Wake-up sequence
  trigger:
    - at: 09:00:00
      platform: time
  condition:
    - condition: state
      entity_id: input_select.presence
      state:
        - With Guests
    - condition: template
      value_template: "{{ state_attr('automation.smart_wake_up_guest_room','last_triggered').day != utcnow().day }}"
  action:
    - service: script.wake_up
      data:
        warmer: guest_bath_towel_warmer
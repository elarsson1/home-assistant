# script to save the state of one thermostat and set it to Eco mode.
hvac_save_state_eco:
  alias: HVAC Save State
  description: "Save Thermostat state and set to Eco mode"
  mode: parallel
  fields:
    thermostat:
      description: "Thermostat entity to set"
      example: "guest_room"
  sequence:
    # save current status
    - service: input_text.set_value
      data_template:
        entity_id: "input_text.hvac_prev_state_{{ thermostat }}"
        value: "{{ states('climate.' + thermostat) }}"
    # stop if thermostat is already off or in eco
    - condition: template
      value_template: "{{ states('climate.' + thermostat) != 'off' }}"
    - condition: template
      value_template: "{{ state_attr('climate.' + thermostat, 'preset_mode') != 'eco' }}"
    # set thermostat to eco.
    - service: climate.set_preset_mode
      data_template:
        entity_id: "climate.{{ thermostat }}"
        preset_mode: "eco"

# script to restore state of one thermostat
hvac_restore_state:
  alias: HVAC Restore State
  description: "Restore thermostat state, returning from Eco mode"
  mode: parallel
  fields:
    thermostat:
      description: "Thermostat entity to restore"
      example: "guest_room"
  sequence:
    # stop if the thermostat is off
    - condition: template
      value_template: "{{ states('climate.' + thermostat) != 'off' }}"
    # stop if thermostat is not in eco.
    - condition: template
      value_template: "{{ state_attr('climate.' + thermostat, 'preset_mode') == 'eco' }}"
    # turn off eco and restore prior state
    - service: climate.set_hvac_mode
      data_template:
        entity_id: "climate.{{ thermostat }}"
        hvac_mode: "{{ states('input_text.hvac_prev_state_' + thermostat) }}"

# script to set all thermostats to eco
hvac_save_all_state_eco:
  alias: HVAC Save All State
  description: "Save all thermostat state"
  sequence:
    - service: script.hvac_save_state_eco
      data:
        thermostat: living_room
    - service: script.hvac_save_state_eco
      data:
        thermostat: loft
    - service: script.hvac_save_state_eco
      data:
        thermostat: master_bedroom
    - service: script.hvac_save_state_eco
      data:
        thermostat: guest_room

# script to restore all thermostats
hvac_restore_all_state:
  alias: HVAC Restore State
  description: "Restore all thermostats to normal mode from eco"
  sequence:
    - service: script.hvac_restore_state
      data:
        thermostat: living_room
    - service: script.hvac_restore_state
      data:
        thermostat: loft
    - service: script.hvac_restore_state
      data:
        thermostat: master_bedroom
    - service: script.hvac_restore_state
      data:
        thermostat: guest_room